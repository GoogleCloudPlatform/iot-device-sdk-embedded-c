name: POSIX Builds

on:
  workflow_dispatch:
    inputs:
      foo:
        description: 'foo'
        default: 'bar'
        required: false

jobs:
  build:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        preset: [POSIX_DEV, POSIX_DEV_MIN, POSIX_REL, POSIX_REL_MIN, POSIX_THREADING_REL]
        tls_lib: [mbedtls, wolfssl]
    steps:
      - name: Checkout Repo
        uses: actions/checkout@v2
        with:
          submodules: recursive

      - name: Submodule update
        shell: bash
        run: |
          set -e
          git submodule init
          git submodule update

      - name: Update Apt
        shell: bash
        run: sudo apt-get update

      - name: Apt Install Prereqs
        run: |
          set -e
          sudo apt-get install expect
          # sudo apt-get install clang-3.8
          # sudo apt-get qemu-system
          # sudo apt-get libc6:i386
          # sudo apt-get libc6-dev-i386
          # sudo apt-get gcc-multilib
          # sudo apt-get linux-libc-dev:i386
          # sudo apt-get device-tree-compiler
          # sudo apt-get gperf
          # sudo apt-get dfu-util
          # sudo apt-get xz-utils
          # sudo apt-get python3-pip
          
      - name: Build SDK
        shell: bash
        run: |
          expect res/travis/travis_build_${{matrix.tls_lib}}.expect make MAKEFILE_DEBUG=1 PRESET=${{ matrix.preset }}
      
      - name: Build Examples
        shell: bash
        run: |
          make -C examples/iot_core_mqtt_client IOTC_CLIENT_LIB_PATH=../../bin/linux IOTC_BSP_TLS=${{ matrix.tls_lib }}
